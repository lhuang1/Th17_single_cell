---
title: "TCR analysis"
output: html_notebook
---

```{r}
library(dplyr)
library(tidyr)
library(tibble)
library(pheatmap)
library(gridExtra)
library(ggplot2)
dir_out <- "../../2_pipeline/TCR/gliph/"
if (!dir.exists(dir_out)) {
  dir.create(dir_out)
}

today <- Sys.Date()
tissue_vec_ut <- c("SPL", "MLN", "PP", "SI", "COL")
tissue_vec_eae <- c("SPL", "MLN", "PP", "SI", "COL", "CNS", "DLN")
```


## GLIPH analysis to identify clusters of TCRs

### Prepare input for GLIPH2.

Input format: (http://50.255.35.37:8080/demo)
CDR3b  TRBV  TRBJ  CDR3a  subject:condition count
CSARDQGGAGNQPQHF	TRBV20-1	TRBJ1-5	CAVGVGYKLSF	01/0906:MtbLys	1
All fields are tab-delimited except that subject and condition are delimited with ":". Condition can be anything such as tissue type, cell subset or treatment et al. CDR3b, TRBV, subject, and count are required. Other fields can be replaced with "NA". A demo input TCR dataset can be found at the link TCR

Pool data from all mice and run at once.
```{r}
meta <- readRDS("../../for_paper/results/preprocessing/meta_processed_dominant_TCR_2020-03-24.rds")
cell_name_meta <- sub(".*?_", "", rownames(meta))

dir_tcr <- "../../2_pipeline/preprocessing/tcr/2020-03-24/"
file_vec <- list.files(dir_tcr, pattern = "*filtered_contigs_dominant.rds")
input_table <- list()
two_beta <- list()
for (file_name in file_vec) {
  cat(file_name, "\n")
  tmp <- strsplit(file_name, split = "_") %>% unlist
  treatment <- tmp[1]; batch <- tmp[2]; mouse <- tmp[3]
  filtered_contigs <- readRDS(paste0(dir_tcr, file_name))
  filtered_contigs$cell_name <- paste0(treatment, "_", batch, "_", mouse, "_", sub("-.*", "", as.character(filtered_contigs$barcode)))
  filtered_contigs_wide <- filtered_contigs %>% 
    arrange(-umis) %>% 
    group_by(cell_name) %>% 
    summarise(CDR3b = paste(as.character(cdr3[chain == "TRB"]), collapse = ":"),
              TRBV = paste(as.character(v_gene[chain == "TRB"]), collapse = ":"),
              TRBJ = paste(as.character(j_gene[chain == "TRB"]), collapse = ":"),
              CDR3a = as.character(cdr3[chain == "TRA"][1])) %>%  # take the first one since GLIPH only uses beta chain.
    mutate(CDR3a = ifelse(is.na(CDR3a), "NA", CDR3a))
  
  idx_two_beta <- grep(":", filtered_contigs_wide$CDR3b)
  tmp <- filtered_contigs_wide[idx_two_beta,]
  two_beta[[file_name]] <- tmp
  filtered_contigs_wide[idx_two_beta,] <- tmp %>% mutate(CDR3b = sub(":.*", "", CDR3b),
                                                         TRBV = sub(":.*", "", TRBV),
                                                         TRBJ = sub(":.*", "", TRBJ))
  filtered_contigs_wide <- rbind(filtered_contigs_wide, 
                                 tmp %>% mutate(CDR3b = sub(".*:", "", CDR3b),
                                                TRBV = sub(".*:", "", TRBV),
                                                TRBJ = sub(".*:", "", TRBJ),
                                                cell_name = paste0(cell_name, ".2")))
  
  ## subject:condition
  filtered_contigs_wide$tissue = meta$tissue[match(sub(".2", "", filtered_contigs_wide$cell_name), cell_name_meta)]
  filtered_contigs_wide$subject_cond <- paste0(paste(batch, treatment, mouse, sep = "_"), ":", filtered_contigs_wide$tissue)
  input_table[[file_name]] <- filtered_contigs_wide %>% group_by(CDR3b, TRBV, TRBJ, CDR3a, subject_cond) %>% tally(name = "count")
}

input_table_df <- Reduce(rbind, input_table)
write.table(input_table_df, file = paste0(dir_out, "gliph_input_tcr.txt"), sep = "\t", quote = F, col.names = F, row.names = F)
# only UT, valid and invalid tissue labels
input_table_df_ut <- input_table_df %>% filter(grepl("UT", subject_cond))
write.table(input_table_df_ut, file = paste0(dir_out, "gliph_input_tcr_ut.txt"), sep = "\t", quote = F, col.names = F, row.names = F)

# only EAE, valid and invalid tissue labels
input_table_df_eae <- input_table_df %>% filter(grepl("EAE", subject_cond))
write.table(input_table_df_eae, file = paste0(dir_out, "gliph_input_tcr_eae.txt"), sep = "\t", quote = F, col.names = F, row.names = F)


# only UT, valid tissue labels
input_table_df_ut <- input_table_df %>% filter(grepl("UT", subject_cond), !grepl("NA", subject_cond))
write.table(input_table_df_ut, file = paste0(dir_out, "gliph_input_tcr_ut_valid.txt"), sep = "\t", quote = F, col.names = F, row.names = F)

# only EAE, valid tissue labels
input_table_df_eae <- input_table_df %>% filter(grepl("EAE", subject_cond), !grepl("NA", subject_cond))
write.table(input_table_df_eae, file = paste0(dir_out, "gliph_input_tcr_eae_valid.txt"), sep = "\t", quote = F, col.names = F, row.names = F)

saveRDS(two_beta, file = paste0(dir_out, "cells_two_beta.rds"))
```


Run GLIPH. (make sure to change date ../../2_pipeline/TCR/gliph/parameter_table)

```{r}
parameter_table <- c(
  paste0("out_prefix=", today, "_ut"), # date and treatment
  "cdr3_file=/singerlab/linglin/Th17_single_cell_eae_ut/2_pipeline/TCR/gliph/gliph_input_tcr_ut.txt", # treatment
  "refer_file=/homes10/lhuang/utils/gliph2/mouse_v1.0/ref_CD4_ms.txt",
  "v_usage_freq_file=/homes10/lhuang/utils/gliph2/mouse_v1.0/ref_V_CD4_ms.txt",
  "cdr3_length_freq_file=/homes10/lhuang/utils/gliph2/mouse_v1.0/ref_L_CD4_ms.txt",
  "local_min_pvalue=0.001",
  "p_depth = 1000",
  "global_convergence_cutoff = 1",
  "simulation_depth=1000",
  "kmer_min_depth=3",
  "local_min_OVE=10",
  "algorithm=GLIPH2",
  "all_aa_interchangeable=1"
)
write.table(parameter_table, file = paste0(dir_out, "parameter_table_", today, ".txt"), sep = "\n", quote = F, col.names = F, row.names = F)
```


```{bash, eval = F}
cd /homes10/lhuang/utils/gliph2/
./irtools.centos -c /singerlab/linglin/Th17_single_cell_eae_ut/2_pipeline/TCR/gliph/parameter_table_2021-09-22.txt
#cp 2021-08-10_ut_valid* /singerlab/linglin/Th17_single_cell_eae_ut/2_pipeline/TCR/gliph/
```


<!-- analyze gliph output -->
<!-- ```{r} -->
<!-- two_beta <- readRDS(file = paste0(dir_out, "cells_two_beta.rds")) -->
<!-- res <- read.table("../../2_pipeline/TCR/gliph/2021-08-10_ut_eae_cluster.csv", sep = ",", header = T) -->
<!-- # res <- read.table("../../2_pipeline/TCR/gliph/2021-08-10_ut_valid_cluster.csv", sep = ",", header = T) -->
<!-- # res <- read.table("../../2_pipeline/TCR/gliph/20210728_cluster.csv", sep = ",", header = T) -->
<!-- res <- res %>%  -->
<!--   filter(pattern != "single") %>%  -->
<!--   filter(Fisher_score < 0.05) -->
<!-- dim(res) -->
<!-- table(sub("-.*", "", unique(res$type))) ## 298 global and 48 motif clusters -->

<!-- res <- res %>% filter(grepl("global", type)) # only keep global clusters -->

<!-- two_beta_df <- Reduce(rbind, two_beta[grep("UT", names(two_beta))]) %>%  -->
<!--   mutate(CDR3b_1 = sub(":.*", "", CDR3b), -->
<!--          CDR3b_2 = sub(".*:", "", CDR3b)) -->
<!-- two_beta_df <- unique(two_beta_df[,-1]) -->

<!-- idx_1 <- which(two_beta_df$CDR3b_1 %in% res$TcRb) # which cells are found in a valid cluster based on the first beta chain -->
<!-- idx_2 <- which(two_beta_df$CDR3b_2 %in% res$TcRb) # which cells are found in a valid cluster based on the second beta chain -->
<!-- idx_1_2 <- intersect(idx_1, idx_2) # both chains are in cluster(s) -->

<!-- res$index_merge <- res$index -->
<!-- for (i in idx_1_2){ -->
<!--   res_idx_1 <- which(as.character(res$TcRb) == as.character(two_beta_df[i,"CDR3b_1"])) -->
<!--   res_idx_2 <- which(as.character(res$TcRb) == as.character(two_beta_df[i,"CDR3b_2"])) -->
<!--   cluster_idx_1 <- res$index[res_idx_1[1]] -->
<!--   cluster_idx_2 <- res$index[res_idx_2[1]] -->
<!--   cat("original cluster index for", i, ":", cluster_idx_1, cluster_idx_2, "\n") -->
<!--   new_cluster_idx <- paste0(cluster_idx_1, "_m") -->
<!--   res$index_merge[res$index == cluster_idx_1] <- new_cluster_idx -->
<!--   res$index_merge[res$index == cluster_idx_2] <- new_cluster_idx -->
<!-- } -->
<!-- # table(res$index_merge) -->

<!-- mtx <- res %>%  -->
<!--   mutate(tissue = sub(".*:", "", Sample), -->
<!--          treatment = sub(".*?_", "", Sample) %>% sub("_.*", "", .), -->
<!--          tt = paste(tissue, treatment, sep = "_"), -->
<!--          index = paste0("Cluster_", index)) %>%  -->
<!--   filter(tissue != "NA", treatment == "UT") %>%  -->
<!--   group_by(index, tissue) %>%  -->
<!--   summarise(cluster_size = sum(Freq)) %>%  -->
<!--   ungroup() %>%  -->
<!--   spread(key = tissue, value = cluster_size) %>%  -->
<!--   column_to_rownames(var = "index") -->
<!-- mtx[is.na(mtx)] <- 0 -->
<!-- mtx <- mtx[,tissue_vec_ut] -->
<!-- pct_mtx <- mtx / rowSums(mtx) * 100 -->
<!-- cluster_size_vec <- rowSums(mtx) -->
<!-- summary(cluster_size_vec) -->

<!-- library(pheatmap) -->

<!-- # idx_row <- do.call(order, -mtx) -->
<!-- # mtx_cap <- mtx -->
<!-- # mtx_cap[mtx > 10] <- 10 -->
<!-- # p1 <- pheatmap(mtx_cap[idx_row,], -->
<!-- #          color = colorRampPalette(c("white", "red"))(100), -->
<!-- #          cluster_rows = F, -->
<!-- #          cluster_cols = F, -->
<!-- #          clustering_method = "single", -->
<!-- #          show_rownames = F, -->
<!-- #          silent = F, -->
<!-- #          main = "Number of cells (cap at 10)") -->


<!-- which_specific <- which((rowSums(mtx > 0)) == 1) -->
<!-- which_not_specific <- setdiff(1:nrow(mtx), which_specific) -->
<!-- idx_row_1 <- which_specific[do.call(order, -cbind(pct_mtx, cluster_size_vec)[which_specific, ])]  -->
<!-- idx_row_2 <- which_not_specific[do.call(order, -cbind(pct_mtx, cluster_size_vec)[which_not_specific,])] -->
<!-- idx_row <- c(idx_row_1, idx_row_2)  -->
<!-- pct_mtx <- pct_mtx[idx_row,] -->
<!-- p <- pheatmap(pct_mtx, -->
<!--          color = colorRampPalette(c("white", "red"))(100), -->
<!--          cluster_rows = F, -->
<!--          cluster_cols = F, -->
<!--          clustering_method = "complete", -->
<!--          show_rownames = F, -->
<!--          silent = F,  -->
<!--          border_color = "grey95", -->
<!--          main = "") -->
<!-- which_col_names <- which(p$gtable$layout$name == "col_names") -->
<!-- p$gtable$grobs[[which_col_names]]$rot = 0 -->
<!-- p$gtable$grobs[[which_col_names]]$hjust = 0.5 -->
<!-- p$gtable$grobs[[which_col_names]]$vjust = 1 -->
<!-- p$gtable$grobs[[which_col_names]]$gp$fontsize = 13 -->

<!-- p_total <- pheatmap(matrix(cluster_size_vec[idx_row], ncol = 1, dimnames = list(c(), c("Total"))), -->
<!--          color = colorRampPalette(c("grey90", "black"))(100), -->
<!--          breaks = seq(1, 9, length.out = 101), -->
<!--          legend_breaks = c(1, 3, 5, 7, 9), -->
<!--          cluster_rows = F, -->
<!--          cluster_cols = F, -->
<!--          clustering_method = "complete", -->
<!--          show_rownames = F, -->
<!--          # legend = F, -->
<!--          silent = F,  -->
<!--          border_color = "grey95", -->
<!--          main = "") -->
<!-- which_col_names <- which(p_total$gtable$layout$name == "col_names") -->
<!-- p_total$gtable$grobs[[which_col_names]]$rot = 0 -->
<!-- p_total$gtable$grobs[[which_col_names]]$hjust = 0.5 -->
<!-- p_total$gtable$grobs[[which_col_names]]$vjust = 1 -->
<!-- p_total$gtable$grobs[[which_col_names]]$gp$fontsize = 13 -->

<!-- # pct_long <- pct_mtx %>% data.frame() %>%  -->
<!-- #   rownames_to_column(var = "cluster") %>%  -->
<!-- #   gather(key = "tissue", value = "pct", -cluster) %>%  -->
<!-- #   mutate(tissue = factor(sub("_UT", "", tissue), levels = paste0(tissue_vec_ut)), -->
<!-- #          cluster = factor(cluster, levels = rev(rownames(pct_mtx)))) -->
<!-- # ggplot(pct_long) + -->
<!-- #   geom_tile(aes(x = tissue, y = cluster, fill = pct)) + -->
<!-- #   labs(x = "", y = "GLIPH clusters", fill = "% cells") + -->
<!-- #   scale_fill_gradient(low = "white", high = "red") + -->
<!-- #   theme_bw() + -->
<!-- #   theme() -->
<!-- pdf(paste0(dir_out, "heatmap_cluster_by_tissue_UT_", today, ".pdf"), width = 6, height = 4) -->
<!-- # grid.arrange(p1$gtable) -->
<!-- grid.arrange(p$gtable, p_total$gtable, nrow = 1, widths = c(4, 1)) -->
<!-- dev.off() -->
<!-- ``` -->


<!-- ```{r} -->
<!-- mtx <- res %>%  -->
<!--   mutate(tissue = sub(".*:", "", Sample) %>% sub("_.*", "", .), -->
<!--          treatment = sub(".*?_", "", Sample) %>% sub("_.*", "", .), -->
<!--          tt = paste(tissue, treatment, sep = "_")) %>%  -->
<!--   filter(tissue != "NA", treatment == "EAE") %>%  -->
<!--   group_by(index, tt) %>%  -->
<!--   summarise(cluster_size = sum(Freq)) %>%  -->
<!--   ungroup() %>%  -->
<!--   spread(key = tt, value = cluster_size) %>%  -->
<!--   column_to_rownames(var = "index") -->
<!-- mtx[is.na(mtx)] <- 0 -->
<!-- pct_mtx <- mtx / rowSums(mtx) * 100 -->

<!-- library(pheatmap) -->
<!-- pheatmap(pct_mtx, -->
<!--          color = colorRampPalette(c("white", "red"))(100), -->
<!--          cluster_rows = T, -->
<!--          cluster_cols = T, -->
<!--          show_rownames = F, -->
<!--          silent = F) -->

<!-- ``` -->

## Compare to known sequences

### 2D2 sequences
https://www.jax.org/strain/006912 
```{r}
## 2d2 sequence
dist_2d2_alpha <- adist(x = "VYFCALRSYNFG", y = input_table_df$CDR3a)
dist_2d2_beta <- adist(x = "CASSLDCGANP", y = input_table_df$CDR3b)

min_alpha <- which(dist_2d2_alpha == min(dist_2d2_alpha))
min_beta <- which(dist_2d2_beta == min(dist_2d2_beta))
tmp <- rank(dist_2d2_alpha) + rank(dist_2d2_beta)
min_alpha_beta <- which(tmp == min(tmp))
cat("min dist alpha:", min(dist_2d2_alpha), "\n")
cat("min dist beta:", min(dist_2d2_beta), "\n")
cat("min dist alpha+beta:", dist_2d2_alpha[min_alpha_beta[1]] + dist_2d2_beta[min_alpha_beta[1]], "\n")
input_table_df[min_alpha,]
input_table_df[min_beta,]
input_table_df[min_alpha_beta,]
```

### Mark Davis
https://www.ncbi.nlm.nih.gov/pmc/articles/PMC7145319/

```{r}
seq_ls <- list(
  "EAE1_CD4" = c("alpha" = "CAASEGQGGRALIF",
                 "beta" = "CASGDAGGGQNTLYF"),
  "EAE2_CD4" = c("alpha" = "CALRNYNQGKLIF",
                 "beta" = "CASSLDQGWDERLFF"),
  "EAE3_CD4" = c("alpha" = "CAASGANNNNAPRF",
                 "beta" = "CASSLEGHQDTQYF"),
  "EAE4_CD4" = c("alpha" = "CAVSAGTNAYKVIF",
                 "beta" = "CAVSAGTNAYKVIF")
)

for (i in names(seq_ls)) {
  cat("\n", i, "\n")
  seq_a = seq_ls[[i]]["alpha"]
  seq_b = seq_ls[[i]]["beta"]
  dist_2d2_alpha <- adist(x = seq_a, y = input_table_df$CDR3a)
  dist_2d2_beta <- adist(x = seq_b, y = input_table_df$CDR3b)
  
  min_alpha <- which(dist_2d2_alpha == min(dist_2d2_alpha))
  min_beta <- which(dist_2d2_beta == min(dist_2d2_beta))
  tmp <- rank(dist_2d2_alpha) + rank(dist_2d2_beta)
  min_alpha_beta <- which(tmp == min(tmp))
  cat("min dist alpha:", min(dist_2d2_alpha), "\n")
  cat("min dist beta:", min(dist_2d2_beta), "\n")
  cat("min dist alpha+beta:", dist_2d2_alpha[min_alpha_beta[1]] + dist_2d2_beta[min_alpha_beta[1]], "\n")
  print(input_table_df[min_alpha,])
  print(input_table_df[min_beta,])
  print(input_table_df[min_alpha_beta,])
}

```

```{r}
for (i in names(seq_ls)) {
  if (i != "EAE1_CD4") next
  match_1_b <- input_table_df %>% filter(CDR3b == seq_ls[[i]]["beta"])
  df_1_b <- strsplit(match_1_b$subject_cond, split = ":") %>% Reduce(rbind, .) %>% data.frame() 
  colnames(df_1_b) <- c("sample", "tissue")
  df_1_b$count <- match_1_b$count
  print(df_1_b %>% group_by(sample, tissue) %>% summarise(n = sum(count)) %>% spread(key = tissue, value = n))
}


match_1_a_b <- input_table_df %>% filter(CDR3b == seq_ls$EAE1_CD4["beta"], CDR3a == seq_ls$EAE1_CD4["alpha"])
match_1_a_b

```

